<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Rio Genil - Ecija</title>
    <meta name="description" content="Monitor en tiempo real del nivel y caudal del Rio Genil a su paso por Ecija">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Rio Genil">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800;900&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-base: #070b14;
            --bg-card: rgba(15, 23, 42, 0.85);
            --border-card: rgba(51, 65, 85, 0.6);
            --text-main: #f1f5f9;
            --text-muted: #7c8db5;
            --accent: #3b82f6;
            --verde: #22c55e;
            --amarillo: #eab308;
            --naranja: #f97316;
            --rojo: #ef4444;
            --critico: #991b1b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-base);
            min-height: 100vh;
            color: var(--text-main);
            padding: 12px;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse 80% 60% at 50% -20%, rgba(59,130,246,0.12) 0%, transparent 70%),
                radial-gradient(ellipse 50% 40% at 80% 100%, rgba(59,130,246,0.06) 0%, transparent 60%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 520px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            padding: 22px 16px 18px;
            background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
            border-radius: 16px;
            margin-bottom: 14px;
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 8px 30px rgba(37,99,235,0.25);
        }

        .header h1 {
            font-size: 1.6em;
            font-weight: 900;
            letter-spacing: -0.5px;
            color: #fff;
        }

        .header-sub {
            color: rgba(255,255,255,0.7);
            font-size: 0.82em;
            margin-top: 2px;
            letter-spacing: 1px;
        }

        .live-badge {
            display: inline-block;
            margin-top: 10px;
            padding: 4px 14px;
            border-radius: 20px;
            font-size: 0.7em;
            font-weight: 700;
            background: rgba(34,197,94,0.15);
            color: var(--verde);
            border: 1px solid var(--verde);
            letter-spacing: 1.5px;
        }

        .live-badge.error {
            background: rgba(239,68,68,0.15);
            color: var(--rojo);
            border-color: var(--rojo);
        }

        .live-dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--verde);
            margin-right: 5px;
            animation: blink 2s infinite;
        }

        .live-badge.error .live-dot {
            background: var(--rojo);
            animation: none;
        }

        @keyframes blink {
            0%,100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-card);
            border-radius: 18px;
            padding: 28px 18px;
            margin-bottom: 14px;
            backdrop-filter: blur(12px);
            box-shadow: 0 4px 24px rgba(0,0,0,0.3);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .card-glow {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            border-radius: 18px 18px 0 0;
        }

        .glow-verde   { background: var(--verde); box-shadow: 0 0 20px var(--verde); }
        .glow-amarillo { background: var(--amarillo); box-shadow: 0 0 20px var(--amarillo); }
        .glow-naranja  { background: var(--naranja); box-shadow: 0 0 25px var(--naranja); }
        .glow-rojo     { background: var(--rojo); box-shadow: 0 0 30px var(--rojo); }
        .glow-critico  { background: var(--critico); box-shadow: 0 0 40px var(--critico); animation: pulse-glow 1.2s infinite; }

        @keyframes pulse-glow {
            0%,100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .nivel-label {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 3px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .nivel-valor {
            font-family: 'JetBrains Mono', monospace;
            font-size: 5.5em;
            font-weight: 700;
            line-height: 1;
            text-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .nivel-unidad {
            font-family: 'Outfit', sans-serif;
            font-size: 0.3em;
            color: var(--text-muted);
            margin-left: 4px;
            font-weight: 600;
            vertical-align: super;
        }

        .c-verde   { color: var(--verde); }
        .c-amarillo { color: var(--amarillo); }
        .c-naranja  { color: var(--naranja); }
        .c-rojo     { color: var(--rojo); }
        .c-critico  { color: var(--critico); animation: pulse-text 1s infinite; }

        @keyframes pulse-text {
            0%,100% { transform: scale(1); }
            50% { transform: scale(1.04); }
        }

        .alert-pill {
            display: inline-block;
            margin-top: 16px;
            padding: 10px 32px;
            border-radius: 30px;
            font-weight: 800;
            font-size: 1em;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .pill-verde   { background: rgba(34,197,94,0.15); color: var(--verde); border: 1px solid rgba(34,197,94,0.4); }
        .pill-amarillo { background: rgba(234,179,8,0.15); color: var(--amarillo); border: 1px solid rgba(234,179,8,0.4); }
        .pill-naranja  { background: rgba(249,115,22,0.15); color: var(--naranja); border: 1px solid rgba(249,115,22,0.4); }
        .pill-rojo     { background: rgba(239,68,68,0.15); color: var(--rojo); border: 1px solid rgba(239,68,68,0.4); animation: pulse-pill 2s infinite; }
        .pill-critico  { background: rgba(153,27,27,0.2); color: #fca5a5; border: 1px solid rgba(153,27,27,0.6); animation: pulse-pill 1s infinite; }

        @keyframes pulse-pill {
            0%,100% { transform: scale(1); }
            50% { transform: scale(1.06); }
        }

        .data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .data-box {
            background: rgba(15,23,42,0.6);
            border: 1px solid var(--border-card);
            border-radius: 14px;
            padding: 16px 12px;
            text-align: center;
        }

        .data-box-label {
            font-size: 0.68em;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .data-box-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5em;
            font-weight: 700;
            color: var(--text-main);
        }

        .data-box-unit {
            font-family: 'Outfit', sans-serif;
            font-size: 0.55em;
            color: var(--text-muted);
            margin-left: 2px;
        }

        .extra-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .extra-item {
            background: rgba(15,23,42,0.4);
            border: 1px solid rgba(51,65,85,0.4);
            border-radius: 10px;
            padding: 10px 6px;
            text-align: center;
        }

        .extra-label {
            font-size: 0.6em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .extra-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.95em;
            font-weight: 700;
        }

        /* --- SLIDER VENTANA TEMPORAL --- */
        .slider-wrap {
            margin-top: 12px;
            padding: 14px 16px;
            background: rgba(15,23,42,0.5);
            border: 1px solid var(--border-card);
            border-radius: 14px;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .slider-title {
            font-size: 0.65em;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-muted);
        }

        .slider-window {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.82em;
            font-weight: 700;
            color: var(--accent);
            background: rgba(59,130,246,0.1);
            padding: 3px 10px;
            border-radius: 8px;
            border: 1px solid rgba(59,130,246,0.25);
        }

        .slider-track {
            position: relative;
            width: 100%;
            padding: 8px 0;
        }

        .slider-input {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(to right, rgba(59,130,246,0.3), rgba(59,130,246,0.15));
            outline: none;
            cursor: pointer;
        }

        .slider-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--accent);
            border: 3px solid var(--bg-base);
            box-shadow: 0 0 10px rgba(59,130,246,0.5), 0 2px 6px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: box-shadow 0.2s;
        }

        .slider-input::-webkit-slider-thumb:hover {
            box-shadow: 0 0 16px rgba(59,130,246,0.7), 0 2px 8px rgba(0,0,0,0.4);
        }

        .slider-input::-moz-range-thumb {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--accent);
            border: 3px solid var(--bg-base);
            box-shadow: 0 0 10px rgba(59,130,246,0.5), 0 2px 6px rgba(0,0,0,0.3);
            cursor: pointer;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
            font-size: 0.58em;
            color: rgba(124,141,181,0.6);
            letter-spacing: 0.5px;
        }

        .thresholds {
            margin-top: 14px;
            padding: 16px;
            background: rgba(15,23,42,0.5);
            border: 1px solid var(--border-card);
            border-radius: 14px;
        }

        .thresholds-title {
            font-size: 0.7em;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .th-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 7px 10px;
            margin: 4px 0;
            border-radius: 8px;
            font-size: 0.82em;
        }

        .th-verde   { background: rgba(34,197,94,0.08); border-left: 3px solid var(--verde); }
        .th-amarillo { background: rgba(234,179,8,0.08); border-left: 3px solid var(--amarillo); }
        .th-naranja  { background: rgba(249,115,22,0.08); border-left: 3px solid var(--naranja); }
        .th-rojo     { background: rgba(239,68,68,0.08); border-left: 3px solid var(--rojo); }
        .th-critico  { background: rgba(153,27,27,0.08); border-left: 3px solid var(--critico); }

        .th-row span:first-child { font-weight: 600; }
        .th-row strong { font-family: 'JetBrains Mono', monospace; font-size: 0.9em; }

        .chart-wrap { padding: 18px; }

        .chart-title {
            font-size: 0.7em;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .chart-empty {
            text-align: center;
            color: var(--text-muted);
            font-size: 0.82em;
            padding: 30px 0;
        }

        canvas { max-height: 220px; }

        .btn-refresh {
            display: block;
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 14px;
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            color: #fff;
            font-family: 'Outfit', sans-serif;
            font-size: 0.95em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 16px rgba(37,99,235,0.3);
            margin-top: 14px;
        }

        .btn-refresh:hover { filter: brightness(1.15); transform: translateY(-1px); }
        .btn-refresh:disabled { background: #334155; color: #64748b; cursor: not-allowed; box-shadow: none; transform: none; }

        .footer {
            text-align: center;
            margin-top: 16px;
            padding: 14px;
            font-size: 0.72em;
            color: var(--text-muted);
            border-top: 1px solid rgba(51,65,85,0.3);
        }

        .footer a {
            color: var(--accent);
            text-decoration: none;
        }

        .disclaimer {
            margin-top: 14px;
            padding: 14px 16px;
            background: rgba(234,179,8,0.06);
            border: 1px solid rgba(234,179,8,0.2);
            border-radius: 12px;
            font-size: 0.7em;
            color: #a0a8c0;
            line-height: 1.6;
            text-align: left;
        }

        .disclaimer-title {
            color: var(--amarillo);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 1.05em;
            margin-bottom: 6px;
        }

        .loading-screen {
            text-align: center;
            padding: 80px 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(59,130,246,0.2);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .error-box {
            background: rgba(239,68,68,0.1);
            border: 1px solid rgba(239,68,68,0.3);
            border-radius: 14px;
            padding: 24px;
            text-align: center;
            margin-bottom: 14px;
        }

        .error-box p { color: var(--text-muted); font-size: 0.85em; margin-top: 8px; }

        .dato-stale {
            color: var(--amarillo);
            font-size: 0.72em;
            margin-top: 6px;
        }
    </style>
</head>
<body>
    <div class="container" id="app"></div>

    <script>
        (function () {
            'use strict';

            var UMBRALES = { amarillo: 2.7, naranja: 4.0, rojo: 5.0, critico: 7.0 };
            var REFRESH_MS = 60000;
            var STALE_MINUTES = 30;
            var INTERVAL_MINUTES = 15;
            var DEFAULT_WINDOW = 3;
            var MIN_WINDOW = 2;
            var MAX_WINDOW = 20;
            var DATA_URL = './datos.json';
            var HISTORICO_URL = './historico.json';

            var state = {
                nivel: 0,
                caudal: 0,
                timestamp: null,
                status: 'loading',
                historico: [],
                refreshing: false,
                ventana: DEFAULT_WINDOW
            };

            var chartInstance = null;

            // --- UTILIDADES ---

            function getAlerta(nivel) {
                if (nivel >= UMBRALES.critico) return { key: 'critico', texto: 'CRITICO' };
                if (nivel >= UMBRALES.rojo)    return { key: 'rojo', texto: 'EMERGENCIA' };
                if (nivel >= UMBRALES.naranja)  return { key: 'naranja', texto: 'ALERTA' };
                if (nivel >= UMBRALES.amarillo) return { key: 'amarillo', texto: 'PRECAUCION' };
                return { key: 'verde', texto: 'NORMAL' };
            }

            function calcTendencia(hist, ventana) {
                if (hist.length < ventana + 1) return { texto: '--', color: 'var(--text-muted)' };
                var actual = hist[hist.length - 1].nivel;
                var anterior = hist[hist.length - 1 - ventana].nivel;
                var diff = actual - anterior;
                if (diff > 0.1)  return { texto: 'Subiendo', color: 'var(--rojo)' };
                if (diff < -0.1) return { texto: 'Bajando', color: 'var(--verde)' };
                return { texto: 'Estable', color: 'var(--text-muted)' };
            }

            function calcVariacion(hist, ventana) {
                if (hist.length < ventana + 1) return '--';
                var actual = hist[hist.length - 1].nivel;
                var anterior = hist[hist.length - 1 - ventana].nivel;
                var diff = actual - anterior;
                var sign = diff >= 0 ? '+' : '';
                return sign + diff.toFixed(2) + ' m';
            }

            function formatVentana(lecturas) {
                var minutos = lecturas * INTERVAL_MINUTES;
                if (minutos < 60) return minutos + ' min';
                var h = Math.floor(minutos / 60);
                var m = minutos % 60;
                if (m === 0) return h + 'h';
                return h + 'h ' + m + 'min';
            }

            function maxVentanaDisponible(hist) {
                var max = hist.length - 1;
                if (max < MIN_WINDOW) return MIN_WINDOW;
                if (max > MAX_WINDOW) return MAX_WINDOW;
                return max;
            }

            function isStale(ts) {
                if (!ts) return false;
                return (Date.now() - new Date(ts).getTime()) / 60000 > STALE_MINUTES;
            }

            function formatTime(ts) {
                if (!ts) return '--:--';
                return new Date(ts).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            }

            function formatDateTime(ts) {
                if (!ts) return '--';
                return new Date(ts).toLocaleString('es-ES');
            }

            // --- FETCH ---

            function loadHistorico() {
                return fetch(HISTORICO_URL + '?t=' + Date.now())
                    .then(function (res) {
                        if (!res.ok) return [];
                        return res.json();
                    })
                    .then(function (arr) {
                        if (!Array.isArray(arr)) return [];
                        return arr.map(function (e) {
                            return {
                                label: formatTime(e.timestamp),
                                nivel: e.nivel,
                                caudal: e.caudal,
                                timestamp: e.timestamp
                            };
                        });
                    })
                    .catch(function () { return []; });
            }

            function fetchData() {
                state.refreshing = true;
                render();

                fetch(DATA_URL + '?t=' + Date.now())
                    .then(function (res) {
                        if (!res.ok) throw new Error('HTTP ' + res.status);
                        return res.json();
                    })
                    .then(function (json) {
                        if (json.status === 'error') {
                            state.status = 'error';
                            state.refreshing = false;
                            render();
                            return;
                        }

                        state.nivel = json.nivel;
                        state.caudal = json.caudal;
                        state.timestamp = json.timestamp;
                        state.status = 'ok';
                        state.refreshing = false;

                        var timeLabel = formatTime(json.timestamp);
                        var last = state.historico[state.historico.length - 1];

                        if (!last || last.timestamp !== json.timestamp) {
                            state.historico.push({
                                label: timeLabel,
                                nivel: json.nivel,
                                caudal: json.caudal,
                                timestamp: json.timestamp
                            });
                        }

                        render();
                        updateChart();
                    })
                    .catch(function () {
                        state.status = 'error';
                        state.refreshing = false;
                        render();
                    });
            }

            // --- SLIDER (sin re-render completo) ---

            function onSliderChange(e) {
                var val = parseInt(e.target.value, 10);
                state.ventana = val;

                var tendencia = calcTendencia(state.historico, val);
                var variacion = calcVariacion(state.historico, val);

                var elTendencia = document.getElementById('val-tendencia');
                var elVariacion = document.getElementById('val-variacion');
                var elWindow = document.getElementById('val-window');

                if (elTendencia) {
                    elTendencia.textContent = tendencia.texto;
                    elTendencia.style.color = tendencia.color;
                }
                if (elVariacion) {
                    elVariacion.textContent = variacion;
                }
                if (elWindow) {
                    elWindow.textContent = formatVentana(val);
                }
            }

            // --- CHART ---

            function updateChart() {
                var canvas = document.getElementById('chart-canvas');
                if (!canvas) return;
                var ctx = canvas.getContext('2d');

                var labels = state.historico.map(function (h) { return h.label; });
                var data = state.historico.map(function (h) { return h.nivel; });

                if (chartInstance) {
                    chartInstance.data.labels = labels;
                    chartInstance.data.datasets[0].data = data;
                    chartInstance.update();
                    return;
                }

                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Nivel (m)',
                            data: data,
                            borderColor: '#3b82f6',
                            backgroundColor: function (context) {
                                var g = context.chart.ctx.createLinearGradient(0, 0, 0, 220);
                                g.addColorStop(0, 'rgba(59,130,246,0.35)');
                                g.addColorStop(1, 'rgba(59,130,246,0.0)');
                                return g;
                            },
                            borderWidth: 2.5,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#3b82f6',
                            pointBorderColor: '#0f172a',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(15,23,42,0.9)',
                                titleFont: { family: 'Outfit', size: 12 },
                                bodyFont: { family: 'JetBrains Mono', size: 12 },
                                padding: 10,
                                cornerRadius: 8
                            }
                        },
                        scales: {
                            y: {
                                grid: { color: 'rgba(51,65,85,0.3)' },
                                ticks: { color: '#7c8db5', font: { family: 'JetBrains Mono', size: 11 } }
                            },
                            x: {
                                grid: { color: 'rgba(51,65,85,0.15)' },
                                ticks: { color: '#7c8db5', font: { family: 'Outfit', size: 10 } }
                            }
                        }
                    }
                });
            }

            // --- RENDER ---

            function render() {
                var root = document.getElementById('app');

                if (state.status === 'loading') {
                    root.innerHTML =
                        '<div class="header">' +
                            '<h1>Rio Genil - Ecija</h1>' +
                            '<p class="header-sub">Estacion A17 - SAIH Guadalquivir</p>' +
                        '</div>' +
                        '<div class="loading-screen">' +
                            '<div class="spinner"></div>' +
                            '<div style="color:var(--text-muted)">Cargando datos...</div>' +
                        '</div>';
                    return;
                }

                var v = state.ventana;
                var alerta = getAlerta(state.nivel);
                var tendencia = calcTendencia(state.historico, v);
                var variacion = calcVariacion(state.historico, v);
                var stale = isStale(state.timestamp);
                var badgeClass = state.status === 'error' ? 'error' : '';
                var maxV = maxVentanaDisponible(state.historico);
                if (v > maxV) { v = maxV; state.ventana = v; }
                var sliderDisabled = state.historico.length < MIN_WINDOW + 1;

                var html = '';

                // Header
                html += '<div class="header">';
                html += '<h1>Rio Genil - Ecija</h1>';
                html += '<p class="header-sub">Estacion A17 - SAIH Guadalquivir</p>';
                html += '<span class="live-badge ' + badgeClass + '">';
                html += '<span class="live-dot"></span>';
                html += (state.status === 'error' ? 'SIN DATOS' : 'EN VIVO');
                html += '</span>';
                html += '</div>';

                // Error
                if (state.status === 'error') {
                    html += '<div class="error-box">';
                    html += '<strong style="font-size:1.1em">Error de conexion</strong>';
                    html += '<p>No se pudieron obtener los datos del SAIH. El scraper puede estar caido o el archivo datos.json no esta disponible.</p>';
                    html += '</div>';
                }

                // Nivel principal
                if (state.status === 'ok') {
                    html += '<div class="card">';
                    html += '<div class="card-glow glow-' + alerta.key + '"></div>';
                    html += '<div class="nivel-label">Altura del agua</div>';
                    html += '<div class="nivel-valor c-' + alerta.key + '">';
                    html += state.nivel.toFixed(2);
                    html += '<span class="nivel-unidad">m</span>';
                    html += '</div>';
                    html += '<div class="alert-pill pill-' + alerta.key + '">' + alerta.texto + '</div>';
                    if (stale) {
                        html += '<div class="dato-stale">Dato antiguo - ultima lectura: ' + formatDateTime(state.timestamp) + '</div>';
                    }
                    html += '</div>';
                }

                // Datos secundarios
                if (state.status === 'ok') {
                    html += '<div class="card">';

                    // Caudal + ultima lectura
                    html += '<div class="data-grid">';
                    html += '<div class="data-box">';
                    html += '<div class="data-box-label">Caudal</div>';
                    html += '<div class="data-box-value" style="color:#60a5fa">';
                    html += (state.caudal > 0 ? state.caudal.toFixed(1) + '<span class="data-box-unit">m3/s</span>' : '<span style="color:var(--text-muted);font-size:0.7em">No disponible</span>');
                    html += '</div></div>';

                    html += '<div class="data-box">';
                    html += '<div class="data-box-label">Ultima lectura</div>';
                    html += '<div class="data-box-value" style="font-size:1.1em">';
                    html += formatDateTime(state.timestamp);
                    html += '</div></div>';
                    html += '</div>';

                    // Tendencia + variacion + ventana
                    html += '<div class="extra-row">';

                    html += '<div class="extra-item">';
                    html += '<div class="extra-label">Tendencia</div>';
                    html += '<div class="extra-value" id="val-tendencia" style="color:' + tendencia.color + '">' + tendencia.texto + '</div>';
                    html += '</div>';

                    html += '<div class="extra-item">';
                    html += '<div class="extra-label">Variacion</div>';
                    html += '<div class="extra-value" id="val-variacion">' + variacion + '</div>';
                    html += '</div>';

                    html += '<div class="extra-item">';
                    html += '<div class="extra-label">Ventana</div>';
                    html += '<div class="extra-value" id="val-window">' + formatVentana(v) + '</div>';
                    html += '</div>';

                    html += '</div>';

                    // Slider
                    html += '<div class="slider-wrap">';
                    html += '<div class="slider-header">';
                    html += '<span class="slider-title">Ventana de analisis</span>';
                    html += '<span class="slider-window" id="slider-badge">' + formatVentana(v) + '</span>';
                    html += '</div>';
                    html += '<div class="slider-track">';
                    html += '<input type="range" class="slider-input" id="slider-ventana"';
                    html += ' min="' + MIN_WINDOW + '" max="' + maxV + '" value="' + v + '"';
                    html += ' step="1"' + (sliderDisabled ? ' disabled' : '') + '>';
                    html += '</div>';
                    html += '<div class="slider-labels">';
                    html += '<span>' + formatVentana(MIN_WINDOW) + '</span>';
                    html += '<span>' + formatVentana(maxV) + '</span>';
                    html += '</div>';
                    html += '</div>';

                    // Umbrales
                    html += '<div class="thresholds">';
                    html += '<div class="thresholds-title">Umbrales de alerta</div>';
                    html += '<div class="th-row th-verde"><span>Normal</span><strong>&lt; ' + UMBRALES.amarillo + ' m</strong></div>';
                    html += '<div class="th-row th-amarillo"><span>Precaucion</span><strong>' + UMBRALES.amarillo + ' - ' + UMBRALES.naranja + ' m</strong></div>';
                    html += '<div class="th-row th-naranja"><span>Alerta</span><strong>' + UMBRALES.naranja + ' - ' + UMBRALES.rojo + ' m</strong></div>';
                    html += '<div class="th-row th-rojo"><span>Emergencia</span><strong>' + UMBRALES.rojo + ' - ' + UMBRALES.critico + ' m</strong></div>';
                    html += '<div class="th-row th-critico"><span>Critico</span><strong>&gt; ' + UMBRALES.critico + ' m</strong></div>';
                    html += '</div>';

                    html += '</div>';
                }

                // Chart
                html += '<div class="card chart-wrap">';
                html += '<div class="chart-title">Evolucion temporal (ultimas ' + state.historico.length + ' lecturas)</div>';
                if (state.historico.length > 1) {
                    html += '<div style="height:220px"><canvas id="chart-canvas"></canvas></div>';
                } else {
                    html += '<div class="chart-empty">Esperando mas lecturas para mostrar la grafica...</div>';
                }
                html += '</div>';

                // Boton
                html += '<button class="btn-refresh" id="btn-refresh"' + (state.refreshing ? ' disabled' : '') + '>';
                html += state.refreshing ? 'Verificando...' : 'Actualizar datos';
                html += '</button>';

                // Disclaimer
                html += '<div class="disclaimer">';
                html += '<div class="disclaimer-title">Aviso importante</div>';
                html += 'Esta pagina NO es una fuente oficial. Los datos se obtienen mediante lectura automatizada de la web del SAIH Guadalquivir y pueden contener errores, retrasos o interrupciones sin previo aviso. ';
                html += 'Este monitor no sustituye a los sistemas oficiales de alerta. Ante cualquier situacion de riesgo, consulte siempre a <strong style="color:var(--text-main)">Proteccion Civil (112)</strong> o la <strong style="color:var(--text-main)">Confederacion Hidrografica del Guadalquivir</strong>. ';
                html += 'El autor no se hace responsable de decisiones tomadas en base a la informacion aqui mostrada.';
                html += '</div>';

                // Footer
                html += '<div class="footer">';
                html += 'Datos: <a href="https://www.chguadalquivir.es/saih" target="_blank" rel="noopener">SAIH - Confederacion Hidrografica del Guadalquivir</a>';
                html += '<br>Actualizacion automatica via GitHub Actions cada 15 min';
                html += '</div>';

                root.innerHTML = html;

                // Bind boton
                var btn = document.getElementById('btn-refresh');
                if (btn) {
                    btn.addEventListener('click', fetchData);
                }

                // Bind slider
                var slider = document.getElementById('slider-ventana');
                if (slider) {
                    slider.addEventListener('input', function (e) {
                        onSliderChange(e);
                        var badge = document.getElementById('slider-badge');
                        if (badge) badge.textContent = formatVentana(parseInt(e.target.value, 10));
                    });
                }

                // Chart
                if (state.historico.length > 1) {
                    chartInstance = null;
                    updateChart();
                }
            }

            // --- INIT ---
            loadHistorico().then(function (entries) {
                if (entries.length > 0) {
                    state.historico = entries;
                }
                fetchData();
                setInterval(fetchData, REFRESH_MS);
            });

            // --- PWA: registro del service worker ---
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js').catch(function (err) {
                    console.warn('SW registro fallido:', err);
                });
            }

        })();
    </script>
</body>
</html>
