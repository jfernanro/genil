<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Rio Genil - Ecija (Solo Cliente)</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        /* Estilos id칠nticos a tu versi칩n original para mantener el dise침o */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            padding: 10px;
            color: #e2e8f0;
        }
        .container { max-width: 800px; margin: 0 auto; }
        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            color: #1e293b;
            text-align: center;
        }
        .nivel-main { font-size: 5rem; font-weight: 800; line-height: 1; }
        .unit { font-size: 1.5rem; color: #64748b; font-weight: 600; }
        .label { text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; font-weight: 600; font-size: 0.875rem; margin-top: 8px; }
        
        /* Colores de estado */
        .status-normal { color: #22c55e; border: 4px solid #22c55e; }
        .status-warning { color: #eab308; border: 4px solid #eab308; }
        .status-alert { color: #f97316; border: 4px solid #f97316; }
        .status-danger { color: #ef4444; border: 4px solid #ef4444; }
        
        .badge {
            display: inline-block; padding: 4px 12px; border-radius: 9999px;
            font-size: 0.75rem; font-weight: 700; background: rgba(255,255,255,0.2);
            margin-top: 8px;
        }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
        .stat-box { background: #f1f5f9; padding: 16px; border-radius: 12px; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: #0f172a; }
        
        .btn {
            background: #3b82f6; color: white; border: none; padding: 12px 24px;
            border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%;
            transition: opacity 0.2s;
        }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }
        
        .error-msg {
            background: #fef2f2; color: #991b1b; padding: 16px; border-radius: 12px;
            border: 1px solid #f87171; margin-bottom: 16px; text-align: left;
        }
        .debug-info { font-size: 0.7rem; color: #94a3b8; margin-top: 4px; font-family: monospace; }
        canvas { width: 100% !important; height: 300px !important; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Configuraci칩n de niveles
        const UMBRALES = { AMARILLO: 2.7, NARANJA: 4.0, ROJO: 5.0 };
        const SAIH_URL = 'https://www.chguadalquivir.es/saih/AforosTabla.aspx';
        
        // Lista de proxies rotativos (El orden importa)
        const PROXIES = [
            'https://api.allorigins.win/raw?url=',     // Suele ser el m치s estable
            'https://api.codetabs.com/v1/proxy?quest=', // A veces a침ade JS extra
            'https://thingproxy.freeboard.io/fetch/',   // Backup
            'https://corsproxy.io/?'                    // A menudo bloqueado, lo dejamos al final
        ];

        const MonitorRio = () => {
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [proxyActivo, setProxyActivo] = useState('');
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            // Funci칩n robusta de scraping por REGEX (Texto puro)
            const intentarScraping = async (proxyUrl) => {
                const targetUrl = proxyUrl + encodeURIComponent(SAIH_URL);
                console.log("Intentando con proxy:", proxyUrl);

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15s timeout

                try {
                    const response = await fetch(targetUrl, { 
                        signal: controller.signal,
                        headers: { 'X-Requested-With': 'XMLHttpRequest' } // A veces ayuda con los bloqueos
                    });
                    clearTimeout(timeoutId);

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const text = await response.text();
                    
                    // L칍GICA DE PARSEO POR TEXTO PURO (M치s resistente que DOMParser)
                    // 1. Buscamos la secci칩n de Ecija y Genil
                    // Normalizamos el texto: may칰sculas y quitamos espacios extra
                    const cleanText = text.toUpperCase().replace(/\s+/g, ' ');
                    
                    // Buscamos patrones: "A17...GENIL...ECIJA" o variaciones
                    if (!cleanText.includes('ECIJA') || !cleanText.includes('GENIL')) {
                        throw new Error('El HTML descargado no contiene datos de Ecija');
                    }

                    // Regex explicada:
                    // Busca "ECIJA" seguido de cualquier cosa hasta encontrar n칰meros decimales (ej: 0,45 o 2.30)
                    // El formato suele ser: [Caudal] ... [Nivel] o viceversa dependiendo de la columna
                    // En la web actual: Columna 3 es Nivel, Columna 7 es Caudal.
                    
                    // Estrategia: Encontrar la fila de la tabla buscando la cadena completa
                    // <TD>A17</TD>...<TD>RIO GENIL</TD>...<TD>ECIJA</TD>
                    
                    // Al usar text puro sin tags, buscamos una secuencia de n칰meros tras la palabra ECIJA
                    // Ejemplo de texto limpio: ... ECIJA 0,45 28/08/2023 10:00 120,5 ...
                    
                    // Vamos a usar un split por "ECIJA" y mirar lo que viene despu칠s
                    const partes = cleanText.split('ECIJA');
                    if (partes.length < 2) throw new Error('No se pudo segmentar el texto');
                    
                    const datosPostEcija = partes[1].trim();
                    // Buscamos todos los n칰meros con formato decimal (1,23 o 1.23)
                    const numerosEncontrados = datosPostEcija.match(/[\d]+[.,]\d{2}/g);

                    if (!numerosEncontrados || numerosEncontrados.length === 0) {
                        throw new Error('No se encontraron n칰meros v치lidos tras Ecija');
                    }

                    // Asumiendo estructura est치ndar del SAIH:
                    // El primer n칰mero suele ser el Nivel (m)
                    // El segundo suele ser la Cota (o tendencia)
                    // El Caudal suele ser mayor y estar m치s adelante.
                    
                    // Vamos a ser conservadores:
                    let nivel = parseFloat(numerosEncontrados[0].replace(',', '.'));
                    
                    // Validaci칩n de cordura para el nivel (no puede ser 200 metros ni -5)
                    if (isNaN(nivel) || nivel < 0 || nivel > 15) {
                        // Si el primer n칰mero falla, intentamos l칩gica alternativa
                        throw new Error(`Nivel detectado no v치lido: ${nivel}`);
                    }

                    // Intentar sacar caudal (a veces est치 lejos, buscamos un n칰mero mayor)
                    let caudal = 0;
                    if (numerosEncontrados.length > 2) {
                         // A veces el caudal viene formateado raro, lo cogemos con pinzas
                         let posibleCaudal = parseFloat(numerosEncontrados[2].replace(',', '.'));
                         if (!isNaN(posibleCaudal)) caudal = posibleCaudal;
                    }

                    return {
                        nivel,
                        caudal,
                        timestamp: new Date().toISOString()
                    };

                } catch (err) {
                    throw err;
                }
            };

            const fetchData = async () => {
                setLoading(true);
                setError(null);

                // Intentar proxies secuencialmente
                for (let proxy of PROXIES) {
                    try {
                        setProxyActivo(new URL(proxy).hostname);
                        const result = await intentarScraping(proxy);
                        
                        // Si llegamos aqu칤, tuvimos 칠xito
                        setData(result);
                        actualizarGrafico(result);
                        setLoading(false);
                        return; // Salir del bucle
                    } catch (e) {
                        console.warn(`Fallo proxy ${proxy}:`, e.message);
                        // Continuar al siguiente proxy
                    }
                }

                // Si llegamos aqu칤, todos fallaron
                setError("No se pudieron obtener datos. Los servidores del SAIH pueden estar ca칤dos o bloqueando conexiones externas.");
                setLoading(false);
            };

            const actualizarGrafico = (nuevoDato) => {
                const now = new Date();
                const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
                
                if (chartInstance.current) {
                    const chart = chartInstance.current;
                    // Mantener solo 칰ltimos 10 puntos
                    if (chart.data.labels.length > 10) {
                        chart.data.labels.shift();
                        chart.data.datasets[0].data.shift();
                    }
                    chart.data.labels.push(timeStr);
                    chart.data.datasets[0].data.push(nuevoDato.nivel);
                    chart.update();
                }
            };

            useEffect(() => {
                fetchData();
                const interval = setInterval(fetchData, 300000); // 5 minutos
                
                // Init chart
                if (chartRef.current) {
                    const ctx = chartRef.current.getContext('2d');
                    chartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Nivel del R칤o (m)',
                                data: [],
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { beginAtZero: false, grid: { color: '#e2e8f0' } },
                                x: { grid: { display: false } }
                            }
                        }
                    });
                }
                
                return () => clearInterval(interval);
            }, []);

            // Determinar estado
            const getEstado = (nivel) => {
                if (!nivel) return { color: 'status-normal', texto: 'Cargando...' };
                if (nivel >= UMBRALES.ROJO) return { color: 'status-danger', texto: 'EMERGENCIA' };
                if (nivel >= UMBRALES.NARANJA) return { color: 'status-alert', texto: 'ALERTA' };
                if (nivel >= UMBRALES.AMARILLO) return { color: 'status-warning', texto: 'PRECAUCI칍N' };
                return { color: 'status-normal', texto: 'NORMAL' };
            };

            if (loading && !data) {
                return (
                    <div className="container" style={{paddingTop: '50px', textAlign: 'center', color: 'white'}}>
                        <div className="spinner"></div>
                        <h2>Conectando con sat칠lite...</h2>
                        <p style={{opacity: 0.7}}>Intentando v칤a {proxyActivo}...</p>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="container">
                        <div className="header">
                            <h1 style={{color:'white'}}>Monitor R칤o Genil</h1>
                        </div>
                        <div className="error-msg">
                            <h3>丘멆잺 Conexi칩n Interrumpida</h3>
                            <p>{error}</p>
                            <div style={{marginTop: '15px'}}>
                                <a href={SAIH_URL} target="_blank" className="btn" style={{display: 'inline-block', width: 'auto', textDecoration: 'none'}}>
                                    Ver web oficial SAIH
                                </a>
                                <button onClick={fetchData} className="btn" style={{marginTop:'10px', background: 'transparent', color: '#991b1b', border: '1px solid #991b1b'}}>
                                    Reintentar conexi칩n
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            const estado = getEstado(data.nivel);

            return (
                <div className="container">
                    <div className="header">
                        <h1 style={{color: 'white', fontSize: '1.5rem'}}>R칤o Genil - 칄cija</h1>
                        <span className="badge">Estaci칩n A17</span>
                    </div>

                    <div className={`card ${estado.color}`} style={{borderWidth: '2px', borderStyle: 'solid'}}>
                        <div className="label">Nivel Actual</div>
                        <div className="nivel-main">
                            {data.nivel.toFixed(2)}
                            <span className="unit">m</span>
                        </div>
                        <div className={`badge`} style={{background: '#1e293b', color: 'white'}}>
                            {estado.texto}
                        </div>
                    </div>

                    <div className="grid-2">
                        <div className="stat-box">
                            <div className="label">Caudal</div>
                            <div className="stat-value">
                                {data.caudal > 0 ? data.caudal.toFixed(2) : '--'}
                                <span style={{fontSize: '0.8rem', color: '#64748b', marginLeft: '4px'}}>m췁/s</span>
                            </div>
                        </div>
                        <div className="stat-box">
                            <div className="label">Fuente</div>
                            <div className="stat-value" style={{fontSize: '1rem'}}>
                                SAIH
                            </div>
                            <div className="debug-info">V칤a {proxyActivo}</div>
                        </div>
                    </div>

                    <div className="card" style={{marginTop: '16px', height: '340px'}}>
                        <div className="label" style={{marginBottom: '10px'}}>Tendencia (칔ltima hora)</div>
                        <div><canvas ref={chartRef}></canvas></div>
                    </div>

                    <div style={{textAlign: 'center', marginTop: '20px'}}>
                        <button onClick={fetchData} className="btn">
                            游댃 Actualizar Ahora
                        </button>
                        <p style={{marginTop: '10px', fontSize: '0.8rem', opacity: 0.6}}>
                            칔ltima lectura: {new Date(data.timestamp).toLocaleTimeString()}
                        </p>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MonitorRio />);
    </script>
</body>
</html>
