<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor R√≠o Genil - √âcija (Alta Precisi√≥n)</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        :root {
            --bg-dark: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.95);
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --accent: #3b82f6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #020617 0%, #1e293b 100%);
            min-height: 100vh;
            color: var(--text-main);
            padding: 15px;
        }

        .container { max-width: 800px; margin: 0 auto; }

        .header {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            background: linear-gradient(to right, #1e3a8a, #2563eb);
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .main-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            border: 2px solid #334155;
            position: relative;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }

        /* Indicadores de Nivel */
        .nivel-display {
            font-size: 6rem;
            font-weight: 800;
            line-height: 1;
            margin: 20px 0;
            text-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .unit { font-size: 2rem; color: var(--text-muted); font-weight: 600; }
        
        .status-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 50px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 1.1rem;
            margin-top: 10px;
            background: rgba(255,255,255,0.1);
        }

        /* Colores din√°micos */
        .color-normal { color: #4ade80; border-color: #4ade80; }
        .bg-normal { background: rgba(74, 222, 128, 0.15); color: #4ade80; border: 1px solid #4ade80; }
        
        .color-warning { color: #facc15; border-color: #facc15; }
        .bg-warning { background: rgba(250, 204, 21, 0.15); color: #facc15; border: 1px solid #facc15; }
        
        .color-alert { color: #fb923c; border-color: #fb923c; }
        .bg-alert { background: rgba(251, 146, 60, 0.15); color: #fb923c; border: 1px solid #fb923c; }
        
        .color-danger { color: #f87171; border-color: #f87171; }
        .bg-danger { background: rgba(248, 113, 113, 0.15); color: #f87171; border: 1px solid #f87171; }

        .grid-data {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .data-box {
            background: rgba(15, 23, 42, 0.6);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #334155;
        }

        .data-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .data-value {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .update-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 20px;
            width: 100%;
        }
        
        .update-btn:hover { filter: brightness(1.1); transform: translateY(-2px); }
        .update-btn:disabled { background: #475569; cursor: not-allowed; transform: none; }

        .debug-log {
            font-family: monospace;
            font-size: 0.7rem;
            color: #64748b;
            margin-top: 20px;
            text-align: left;
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 8px;
            max-height: 100px;
            overflow-y: auto;
        }

        canvas {
            max-height: 250px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Configuraci√≥n cr√≠tica
        const SAIH_URL = "https://www.chguadalquivir.es/saih/AforosTabla.aspx";
        const UMBRALES = { AMARILLO: 2.7, NARANJA: 4.0, ROJO: 5.0 };
        
        // Proxies optimizados para evitar cach√© y bloqueos 408
        const PROXIES = [
            { url: 'https://api.allorigins.win/raw?url=', type: 'raw' },
            { url: 'https://api.codetabs.com/v1/proxy?quest=', type: 'raw' },
            { url: 'https://corsproxy.io/?', type: 'raw' },
            { url: 'https://api.allorigins.win/get?url=', type: 'json' } // Backup JSON
        ];

        const App = () => {
            const [data, setData] = useState({ nivel: 0, caudal: 0, status: 'loading' });
            const [logs, setLogs] = useState([]);
            const [lastUpdate, setLastUpdate] = useState(null);
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            const addLog = (msg) => setLogs(prev => [`[${new Date().toLocaleTimeString()}] ${msg}`, ...prev].slice(0, 5));

            // Funci√≥n nuclear para extraer la tabla s√≠ o s√≠
            const parseHTMLTable = (htmlContent) => {
                try {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlContent, 'text/html');
                    
                    // 1. Buscar todas las filas (TR)
                    const rows = doc.querySelectorAll('tr');
                    
                    for (let row of rows) {
                        const text = row.textContent.toUpperCase();
                        
                        // CLAVE: Buscamos la fila espec√≠fica de Ecija y el r√≠o Genil
                        if (text.includes('ECIJA') && text.includes('GENIL')) {
                            const cells = row.querySelectorAll('td');
                            
                            // DEBUG: Ver qu√© celdas ha encontrado el navegador
                            console.log(`Celdas encontradas: ${cells.length}`);
                            
                            // L√≥gica de celdas del SAIH Guadalquivir:
                            // [0]: Rio, [1]: Codigo, [2]: Estacion(Nombre), [3]: Nivel, ..., [7]: Caudal
                            // A veces var√≠a ligeramente si hay columnas ocultas, as√≠ que aseguramos:
                            
                            let nivelRaw = "";
                            let caudalRaw = "";

                            // Intento 1: Por posici√≥n estricta (lo m√°s preciso si la tabla carga bien)
                            if (cells.length > 7) {
                                // Columna 3 suele ser Nivel (√≠ndice 3 porque empieza en 0)
                                // OJO: A veces es √≠ndice 2 o 3 dependiendo de la estructura exacta del d√≠a
                                // Vamos a buscar el valor num√©rico en las celdas cercanas a "ECIJA"
                                
                                // Estrategia de seguridad: Recorrer celdas buscando n√∫meros l√≥gicos
                                for(let i = 0; i < cells.length; i++) {
                                    const val = cells[i].textContent.trim();
                                    
                                    // Si es un n√∫mero decimal razonable (0-15m) y NO es el c√≥digo A17
                                    if(val.match(/^\d+[.,]\d{2}$/) && parseFloat(val.replace(',', '.')) < 20) {
                                        // Asumimos que el primer decimal peque√±o encontrado tras el nombre es el nivel
                                        if(!nivelRaw) {
                                            nivelRaw = val;
                                            // El caudal suele estar unas columnas despu√©s (aprox √≠ndice +4)
                                            if (cells[i+4]) caudalRaw = cells[i+4].textContent;
                                        }
                                    }
                                }
                                
                                // Si el barrido fall√≥, usar √≠ndices hardcodeados (Fallback "respetar celdas")
                                if (!nivelRaw && cells[3]) nivelRaw = cells[3].textContent;
                                if (!caudalRaw && cells[7]) caudalRaw = cells[7].textContent;
                            }

                            if (nivelRaw) {
                                const nivel = parseFloat(nivelRaw.replace(',', '.'));
                                const caudal = parseFloat(caudalRaw.replace(/\./g, '').replace(',', '.')); // Quitar punto de mil
                                
                                if (!isNaN(nivel)) {
                                    return {
                                        nivel: nivel,
                                        caudal: isNaN(caudal) ? 0 : caudal,
                                        found: true
                                    };
                                }
                            }
                        }
                    }
                    return { found: false };
                } catch (e) {
                    console.error("Error parsing DOM:", e);
                    return { found: false };
                }
            };

            const fetchData = async () => {
                setData(prev => ({ ...prev, status: 'loading' }));
                addLog("Iniciando actualizaci√≥n...");
                
                let success = false;

                for (let proxy of PROXIES) {
                    if (success) break;
                    
                    try {
                        // Truco anti-cach√©: A√±adir timestamp aleatorio
                        const timestamp = new Date().getTime();
                        const target = `${proxy.url}${encodeURIComponent(SAIH_URL)}&t=${timestamp}`;
                        
                        addLog(`Probando v√≠a ${new URL(proxy.url).hostname}...`);
                        
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout estricto
                        
                        const response = await fetch(target, { 
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);

                        if (!response.ok) throw new Error(`HTTP ${response.status}`);

                        let htmlContent = "";
                        
                        if (proxy.type === 'json') {
                            const json = await response.json();
                            htmlContent = json.contents; 
                        } else {
                            htmlContent = await response.text();
                        }

                        if (!htmlContent) throw new Error("Contenido vac√≠o");

                        const result = parseHTMLTable(htmlContent);

                        if (result.found) {
                            setData({
                                nivel: result.nivel,
                                caudal: result.caudal,
                                status: 'success'
                            });
                            setLastUpdate(new Date());
                            updateChart(result.nivel);
                            addLog("Datos obtenidos correctamente.");
                            success = true;
                        } else {
                            addLog("HTML recibido pero no se hall√≥ fila ECIJA.");
                        }

                    } catch (err) {
                        console.warn(err);
                        addLog(`Fallo: ${err.message}`);
                    }
                }

                if (!success) {
                    setData(prev => ({ ...prev, status: 'error' }));
                    addLog("Todos los intentos fallaron.");
                }
            };

            // Gr√°fico
            const updateChart = (newVal) => {
                if (chartInstance.current) {
                    const chart = chartInstance.current;
                    const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    if (chart.data.labels.length > 12) {
                        chart.data.labels.shift();
                        chart.data.datasets[0].data.shift();
                    }
                    
                    chart.data.labels.push(time);
                    chart.data.datasets[0].data.push(newVal);
                    chart.update();
                }
            };

            useEffect(() => {
                fetchData();
                const interval = setInterval(fetchData, 180000); // 3 mins

                // Init chart
                if (chartRef.current) {
                    const ctx = chartRef.current.getContext('2d');
                    chartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Nivel (m)',
                                data: [],
                                borderColor: '#3b82f6',
                                backgroundColor: (context) => {
                                    const ctx = context.chart.ctx;
                                    const gradient = ctx.createLinearGradient(0, 0, 0, 250);
                                    gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)');
                                    gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');
                                    return gradient;
                                },
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                                x: { display: false }
                            }
                        }
                    });
                }
                return () => clearInterval(interval);
            }, []);

            // Determinar estilo seg√∫n nivel
            const getStatus = (nivel) => {
                if (data.status === 'error') return { class: 'bg-danger', text: 'ERROR CONEXI√ìN' };
                if (data.status === 'loading') return { class: 'bg-normal', text: 'ACTUALIZANDO...' };
                
                if (nivel >= UMBRALES.ROJO) return { class: 'bg-danger', text: 'üö® EMERGENCIA' };
                if (nivel >= UMBRALES.NARANJA) return { class: 'bg-alert', text: '‚ö†Ô∏è ALERTA' };
                if (nivel >= UMBRALES.AMARILLO) return { class: 'bg-warning', text: 'PRECAUCI√ìN' };
                return { class: 'bg-normal', text: 'NORMAL' };
            };

            const statusInfo = getStatus(data.nivel);

            return (
                <div className="container">
                    <div className="header">
                        <h1 style={{color: 'white', margin: 0}}>Monitor R√≠o Genil</h1>
                        <p style={{color: 'rgba(255,255,255,0.7)', fontSize: '0.9rem'}}>Estaci√≥n A17 - √âcija</p>
                    </div>

                    <div className={`main-card ${data.status === 'success' ? statusInfo.class.split(' ')[0] : ''}`}>
                        <div className="data-label">Altura del Agua</div>
                        
                        <div className="nivel-display">
                            {data.status === 'loading' && data.nivel === 0 ? '--' : data.nivel.toFixed(2)}
                            <span className="unit">m</span>
                        </div>

                        <div className={`status-badge ${statusInfo.class}`}>
                            {statusInfo.text}
                        </div>

                        <div className="grid-data">
                            <div className="data-box">
                                <div className="data-label">Caudal</div>
                                <div className="data-value" style={{color: '#60a5fa'}}>
                                    {data.caudal.toFixed(1)} <span style={{fontSize:'1rem'}}>m¬≥/s</span>
                                </div>
                            </div>
                            <div className="data-box">
                                <div className="data-label">√öltima Lectura</div>
                                <div className="data-value" style={{fontSize: '1.2rem', lineHeight: '2.5rem'}}>
                                    {lastUpdate ? lastUpdate.toLocaleTimeString() : '--:--'}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style={{background: 'rgba(30,41,59,0.5)', padding: '15px', borderRadius: '16px', marginTop: '20px'}}>
                        <div className="data-label" style={{marginBottom: '10px'}}>Tendencia (Tiempo Real)</div>
                        <div><canvas ref={chartRef} height="200"></canvas></div>
                    </div>

                    <button 
                        className="update-btn" 
                        onClick={fetchData} 
                        disabled={data.status === 'loading'}
                    >
                        {data.status === 'loading' ? '‚è≥ Obteniendo datos...' : 'üîÑ Actualizar Ahora'}
                    </button>

                    <div className="debug-log">
                        {logs.map((log, i) => <div key={i}>{log}</div>)}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
