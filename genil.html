<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor R√≠o Genil - √âcija</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        :root {
            --bg-dark: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.95);
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --accent: #3b82f6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #020617 0%, #1e293b 100%);
            min-height: 100vh;
            color: var(--text-main);
            padding: 15px;
        }

        .container { max-width: 800px; margin: 0 auto; }

        .header {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            background: linear-gradient(to right, #1e3a8a, #2563eb);
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .main-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            border: 2px solid #334155;
            position: relative;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }

        .nivel-display {
            font-size: 6rem;
            font-weight: 800;
            line-height: 1;
            margin: 20px 0;
            text-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .unit { font-size: 2rem; color: var(--text-muted); font-weight: 600; }
        
        .status-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 50px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 1.1rem;
            margin-top: 10px;
            background: rgba(255,255,255,0.1);
        }

        /* Colores din√°micos */
        .color-normal { color: #4ade80; border-color: #4ade80; }
        .bg-normal { background: rgba(74, 222, 128, 0.15); color: #4ade80; border: 1px solid #4ade80; }
        
        .color-warning { color: #facc15; border-color: #facc15; }
        .bg-warning { background: rgba(250, 204, 21, 0.15); color: #facc15; border: 1px solid #facc15; }
        
        .color-alert { color: #fb923c; border-color: #fb923c; }
        .bg-alert { background: rgba(251, 146, 60, 0.15); color: #fb923c; border: 1px solid #fb923c; }
        
        .color-danger { color: #f87171; border-color: #f87171; }
        .bg-danger { background: rgba(248, 113, 113, 0.15); color: #f87171; border: 1px solid #f87171; }

        .grid-data {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .data-box {
            background: rgba(15, 23, 42, 0.6);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #334155;
        }

        .data-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .data-value {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .update-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 20px;
            width: 100%;
        }
        
        .update-btn:hover { filter: brightness(1.1); transform: translateY(-2px); }
        .update-btn:disabled { background: #475569; cursor: not-allowed; transform: none; }

        canvas {
            max-height: 250px;
            width: 100%;
        }
        
        .footer-info {
            text-align: center;
            margin-top: 20px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Configuraci√≥n cr√≠tica
        const UMBRALES = { AMARILLO: 2.7, NARANJA: 4.0, ROJO: 5.0 };
        
        const App = () => {
            const [data, setData] = useState({ nivel: 0, caudal: 0, status: 'loading' });
            const [lastUpdate, setLastUpdate] = useState(null);
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            const fetchData = async () => {
                setData(prev => ({ ...prev, status: 'loading' }));
                
                try {
                    // Truco anti-cach√©: A√±adir timestamp para que no cargue datos viejos
                    const timestamp = new Date().getTime();
                    const response = await fetch(`./datos.json?t=${timestamp}`);
                    
                    if (!response.ok) {
                        // Si falla, es probable que el archivo json a√∫n no exista o GitHub est√© tardando
                        throw new Error("Esperando datos del servidor...");
                    }

                    const jsonData = await response.json();
                    
                    // Verificamos si el JSON tiene un error reportado por el scraper
                    if (jsonData.status === 'error') {
                        throw new Error("El sistema no pudo leer la web del SAIH recientemente.");
                    }

                    // Actualizar estado
                    setData({
                        nivel: jsonData.nivel,
                        caudal: jsonData.caudal,
                        status: 'success'
                    });
                    
                    const fechaDato = new Date(jsonData.timestamp);
                    setLastUpdate(fechaDato);
                    updateChart(jsonData.nivel, fechaDato.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));

                } catch (err) {
                    console.error("Error cargando datos:", err);
                    setData(prev => ({ ...prev, status: 'error' }));
                }
            };

            // Gr√°fico
            const updateChart = (newVal, timeLabel) => {
                if (chartInstance.current) {
                    const chart = chartInstance.current;
                    
                    // Mantener solo los √∫ltimos 12 puntos en el gr√°fico
                    if (chart.data.labels.length > 12) {
                        chart.data.labels.shift();
                        chart.data.datasets[0].data.shift();
                    }
                    
                    // Evitar duplicados si la hora es la misma
                    const lastLabel = chart.data.labels[chart.data.labels.length - 1];
                    if (lastLabel !== timeLabel) {
                        chart.data.labels.push(timeLabel);
                        chart.data.datasets[0].data.push(newVal);
                        chart.update();
                    }
                }
            };

            useEffect(() => {
                fetchData();
                // Recargar el JSON cada 60 segundos (el JSON se actualiza en el server cada 15 min)
                const interval = setInterval(fetchData, 60000); 

                // Configurar Gr√°fico
                if (chartRef.current) {
                    const ctx = chartRef.current.getContext('2d');
                    chartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Nivel (m)',
                                data: [],
                                borderColor: '#3b82f6',
                                backgroundColor: (context) => {
                                    const ctx = context.chart.ctx;
                                    const gradient = ctx.createLinearGradient(0, 0, 0, 250);
                                    gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)');
                                    gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');
                                    return gradient;
                                },
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                                x: { display: false }
                            }
                        }
                    });
                }
                return () => clearInterval(interval);
            }, []);

            // Determinar estilo seg√∫n nivel
            const getStatus = (nivel) => {
                if (data.status === 'error') return { class: 'bg-danger', text: 'ERROR DATOS' };
                if (data.status === 'loading' && nivel === 0) return { class: 'bg-normal', text: 'CARGANDO...' };
                
                if (nivel >= UMBRALES.ROJO) return { class: 'bg-danger', text: 'üö® EMERGENCIA' };
                if (nivel >= UMBRALES.NARANJA) return { class: 'bg-alert', text: '‚ö†Ô∏è ALERTA' };
                if (nivel >= UMBRALES.AMARILLO) return { class: 'bg-warning', text: 'PRECAUCI√ìN' };
                return { class: 'bg-normal', text: 'NORMAL' };
            };

            const statusInfo = getStatus(data.nivel);

            return (
                <div className="container">
                    <div className="header">
                        <h1 style={{color: 'white', margin: 0}}>Monitor R√≠o Genil</h1>
                        <p style={{color: 'rgba(255,255,255,0.7)', fontSize: '0.9rem'}}>Estaci√≥n A17 - √âcija</p>
                    </div>

                    <div className={`main-card ${data.status === 'success' ? statusInfo.class.split(' ')[0] : ''}`}>
                        <div className="data-label">Altura del Agua</div>
                        
                        <div className="nivel-display">
                            {data.nivel.toFixed(2)}
                            <span className="unit">m</span>
                        </div>

                        <div className={`status-badge ${statusInfo.class}`}>
                            {statusInfo.text}
                        </div>

                        <div className="grid-data">
                            <div className="data-box">
                                <div className="data-label">Caudal</div>
                                <div className="data-value" style={{color: '#60a5fa'}}>
                                    {data.caudal.toFixed(1)} <span style={{fontSize:'1rem'}}>m¬≥/s</span>
                                </div>
                            </div>
                            <div className="data-box">
                                <div className="data-label">√öltima Actualizaci√≥n</div>
                                <div className="data-value" style={{fontSize: '1.2rem', lineHeight: '2.5rem'}}>
                                    {lastUpdate ? lastUpdate.toLocaleTimeString() : '--:--'}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style={{background: 'rgba(30,41,59,0.5)', padding: '15px', borderRadius: '16px', marginTop: '20px'}}>
                        <div className="data-label" style={{marginBottom: '10px'}}>Tendencia (Hist√≥rico Sesi√≥n)</div>
                        <div><canvas ref={chartRef} height="200"></canvas></div>
                    </div>

                    <button 
                        className="update-btn" 
                        onClick={fetchData} 
                        disabled={data.status === 'loading'}
                    >
                        {data.status === 'loading' ? '‚è≥ Verificando...' : 'üîÑ Recargar Datos'}
                    </button>
                    
                    <div className="footer-info">
                        Datos extra√≠dos autom√°ticamente del SAIH Guadalquivir v√≠a GitHub Actions.
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
